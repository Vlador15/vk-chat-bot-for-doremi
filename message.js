/*===========================================vk.com/c_o_d_e_r===============================================*/
const fs = require("fs");
const { VK, Keyboard } = require("vk-io");
const { HearManager } = require("@vk-io/hear");
const hearManager = new HearManager("<MessageContext>");

const vk = new VK({
  token: "",
  apiMode: "parallel",
  pollingGroupId: 111,
  uploadTimeout: 180e3,
});

const { updates } = vk;
const moment = require("moment"); // –ö—Ä–∞—Å–∏–≤–æ–µ –≤—Ä–µ–º—è!
/*----------------------------------------------------------------------------------------------------------*/
const stats = require("./base/stats.json");
const catalogBD = require("./base/catalog.json");

/*----------------------------------------------------------------------------------------------------------*/

let baseBuilder = Keyboard.builder();
let local_bd_users = {};

/*------------------------------------- Message handling----------------------------------------------------*/

vk.updates.on("message_new", async (message, next) => {
  message.user = message.senderId;
  if (message.user < 0) return;

  if (/\[club167936449\|(.*)\]/i.test(message.text))
    message.text = message.text.replace(/\[club167936449\|(.*)\]/gi, "").trim();

  let [info] = await vk.api.call("users.get", {
    fields: "sex",
    user_ids: message.user,
  });
  if (!local_bd_users[message.user]) {
    local_bd_users[message.user] = {
      category: false,
    };
  }

  if (message.messagePayload != undefined) {
    message.text = message.messagePayload.command;
  }

  if (message.text != null) {
    let word = stats.find((a) => a.name == message.text.toLowerCase());

    if (word) {
      word.all += 1;
      fs.writeFileSync("./base/stats.json", JSON.stringify(stats, null, "\t"));
    }
  }

  try {
    await next();
  } catch (err) {
    console.error(err);
  }
});

vk.updates.on("message_new", hearManager.middleware);

bot(/^(?:—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)/i, async (message) => {
  let urlStats = await getStats();

  message.send(
    `üìù –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è –ø–æ –∫–Ω–æ–ø–∫–∞–º:
  
	  ${stats
      .map((a) => {
        return `üî∏ ${a.name} - ${a.all}`;
      })
      .toString()
      .replace(/,/g, "\n")}
	  `
  );

  return message.send(
    `üìù –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–µ—Ö–æ–¥–∞–º –ø–æ —Å—Å—ã–ª–∫–∞–º:
	  
	${urlStats
    .map((a) => {
      return `üî∏ ${a.name}: ${a.views}`;
    })
    .toString()
    .replace(/,/g, "\n")}
  `,
    { keyboard: String(menu) }
  );
});

const getStats = async (obj) => {
  let object = [];

  catalog_link.map((link) => {
    link.urls.forEach(async (url) => {
      let data = await vk.api.call("utils.getLinkStats", {
        key: url.key,
        interval: "forever",
        source: "vk_cc",
      });
      if (url.key) {
        if (!data.stats.length) {
          object.push({
            views: 0,
            id: link.id,
            name: url.name,
          });
        } else {
          object.push({
            views: data.stats[0].views,
            id: link.id,
            name: url.name,
          });
        }
      }
    });
  });

  let promise = new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve(object);
    }, 2000);
  });

  let result = await promise;
  return result;
};

/*----------------------------------------------------------------------------------------------------------*/

bot(/^(?:–º–µ–Ω—é)/i, async (message) => {
  return message.send(`–ú–µ–Ω—é`, { keyboard: String(menu) });
});

/*----------------------------------------------------------------------------------------------------------*/

bot(/^(?:–∫–∞—Ç–∞–ª–æ–≥)/i, async (message) => {
  return message.send(`–í—ã–±–µ—Ä–∏—Ç–µ —Ü–∏—Ñ—Ä—É –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥: `, {
    attachment: "photo-30313045_457269534",
    keyboard: String(catalog),
  });
});

/*----------------------------------------------------------------------------------------------------------*/

bot(
  /^(?:–∫–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑|–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑|–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –æ–Ω–ª–∞–π–Ω)/i,
  async (message) => {
    return message.send(
      `–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ –Ω–∏–∂–µ üëáüèª.

      üíµ –í–Ω–æ—Å–∏—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É –∑–∞ —Ç–æ–≤–∞—Ä –æ—Ç 500 —Ä—É–±–ª–µ–π:
      - –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ
      - –Ω–∞ –∫–∞—Ä—Ç—É
      - –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º –Ω–∞ —Ä/—Å—á–µ—Ç
      –ª—é–±–æ–π –¥–ª—è –í–∞—Å —É–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.
      
      ‚ùó–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –í–∞–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∏ —á–µ–∫ –æ–± –æ–ø–ª–∞—Ç–µ.
      
      üíµ –ü—Ä–∏–≤–æ–∑–∏–º –º–µ–±–µ–ª—å –∑–∞—Ä–∞–Ω–µ–µ –æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ–µ —Å –í–∞–º–∏ –≤—Ä–µ–º—è.
      –û—Å—Ç–∞—Ç–æ–∫ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç–µ –¥–æ–º–∞ –ª—é–±—ã–º —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.
      üìÉ –ü–µ—Ä–µ–¥–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—ã –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —á–µ–∫–∏ –æ–± –æ–ø–ª–∞—Ç–µ
      
      üéÅ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∫–æ—Ä–æ–±–∫—É –ø–µ—Ä–µ–¥ –í–∞–º–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≤–µ–∑–µ–Ω–Ω–æ–π –º–µ–±–µ–ª–∏. –í—ã —Å–ø–æ–∫–æ–π–Ω—ã –∏ —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –º–µ–±–µ–ª—å –∫ –í–∞–º –ø—Ä–∏–µ—Ö–∞–ª–∞ –≤ –ª—É—á—à–µ–º –≤–∏–¥–µ.
      
      –ü–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –¥–æ–º–∞:
      üìù –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç–µ –∞–∫—Ç-–ø—Ä–∏–µ–º–∞ –ø–µ—Ä–µ–¥–∞—á–∏.
      –ö –í–∞–º –ø—Ä–∏–¥–µ—Ç –°–ú–° —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞—à–µ–π —Ä–∞–±–æ—Ç—ã.
      
      –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã, –ø–∏—à–∏—Ç–µ.
      –û—Ç–≤–µ—á–∞–µ–º –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ.
      `,
      { attachment: "video-30313045_456239139", keyboard: String(menu) }
    );
  }
);

/*----------------------------------------------------------------------------------------------------------*/

bot(/^(?:—Ç–µ–ª–µ—Ñ–æ–Ω)/i, async (message) => {
  return message.send(
    `‚òé –¢–ï–õ–ï–§–û–ù –¥–ª—è —Å–≤—è–∑–∏:

    –≥. –õ–µ–Ω–∏–Ω–æ–≥–æ—Ä—Å–∫
    —É–ª. –≠–Ω–≥–µ–ª—å—Å–∞ 5–∞
    —É–ª. –®–∞—à–∏–Ω–∞ 26
    
    –ï–¥–∏–Ω—ã–π –Ω–æ–º–µ—Ä
    +7 (991) 222-0-777`,
    { keyboard: String(menu) }
  );
});

/*----------------------------------------------------------------------------------------------------------*/

bot(/^(?:–≥—Ä–∞—Ñ–∏–∫)/i, async (message) => {
  return message.send(
    `üóì –ì–†–ê–§–ò–ö –†–ê–ë–û–¢–´:
    –≥. –õ–µ–Ω–∏–Ω–æ–≥–æ—Ä—Å–∫
    —É–ª. –≠–Ω–≥–µ–ª—å—Å–∞ 5–∞
    —É–ª. –®–∞—à–∏–Ω–∞ 26
    
    –ü–Ω-–ü—Ç —Å 08:00-17:00
    –°—É–± 09:00-17:00
    –í–æ—Å 09:00-17:00`,
    { keyboard: String(menu) }
  );
});

/*----------------------------------------------------------------------------------------------------------*/

bot(/^(?:–Ω–∞—à –∞–¥—Ä–µ—Å)/i, async (message) => {
  return message.send(
    `üìç –ù–ê–®–ò –ê–î–†–ï–°–ê:

    –ú–∞–≥–∞–∑–∏–Ω ‚Ññ1
    –≥.–õ–µ–Ω–∏–Ω–æ–≥–æ—Ä—Å–∫ —É–ª. –≠–Ω–≥–µ–ª—å—Å–∞ 5–∞
    
    –°—Å—ã–ª–∫–∞ –∫–∞–∫ –∫ –Ω–∞–º –ø—Ä–æ–µ—Ö–∞—Ç—å https://vk.com/doremi.mebel?w=wall-30313045_36036
    
    –ú–∞–≥–∞–∑–∏–Ω ‚Ññ2
    –≥.–õ–µ–Ω–∏–Ω–æ–≥–æ—Ä—Å–∫ —É–ª. –®–∞—à–∏–Ω–∞ 26 (–í–æ–µ–Ω–∫–æ–º–∞—Ç)
    
    https://clck.ru/StdVG
    –ö–∞–∫ –Ω–∞—Å –Ω–∞–π—Ç–∏ (2 -–æ–π –º–∞–≥–∞–∑–∏–Ω)
	`,
    { keyboard: String(menu) }
  );
});

/*----------------------------------------------------------------------------------------------------------*/

bot(/^(?:–¥–æ—Å—Ç–∞–≤–∫–∞)/i, async (message) => {
  return message.send(
    `–î–û–°–¢–ê–í–ö–ê üöö –î–û–°–¢–ê–í–ö–êüöö –î–û–°–¢–ê–í–ö–êüöö

    ‚óÜ –õ–ï–ù–ò–ù–û–ì–û–†–°–ö
    –î–æ—Å—Ç–∞–≤–∫–∞ –ü–õ–ê–¢–ù–û 400 —Ä—É–±. –ø–æ –≥–æ—Ä–æ–¥—É
    –ü–æ–¥—ä–µ–º –ü–õ–ê–¢–ù–û 200 —Ä. –∑–∞ —ç—Ç–∞–∂
    –°–±–æ—Ä–∫–∞ –ë–ï–°–ü–õ–ê–¢–ù–û* —Ç–æ–ª—å–∫–æ –¥–∏–≤–∞–Ω—ã.
    
    * –°–±–æ—Ä–∫–∞ –∫–æ—Ä–ø—É—Å–Ω–æ–π –º–µ–±–µ–ª–∏ –æ—Ç 10% –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    
    ‚óÜ –ë–£–ì–£–õ–¨–ú–ê
    –î–æ—Å—Ç–∞–≤–∫–∞ –ë–ï–°–ü–õ–ê–¢–ù–û –æ—Ç 80 —Ç—ã—Å—è—á
    –î–æ—Å—Ç–∞–≤–∫–∞ 1000‚ÇΩ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –æ—Ç 50 —Ç—ã—Å—è—á.
    –î–æ 50 —Ç—ã—Å—è—á, –î–æ—Å—Ç–∞–≤–∫–∞ 1500‚ÇΩ
    –ü–æ–¥—ä–µ–º 200‚ÇΩ —ç—Ç–∞–∂.
    
    
    ‚óÜ –ê–õ–¨–ú–ï–¢–¨–ï–í–°–ö, –ê–ó–ù–ê–ö–ê–ï–í–û, –ê–ö–¢–Æ–ë–ê
    –î–æ—Å—Ç–∞–≤–∫–∞ –ë–ï–°–ü–õ–ê–¢–ù–û –æ—Ç 100 —Ç—ã—Å—è—á
    –î–æ—Å—Ç–∞–≤–∫–∞ 1500‚ÇΩ –æ—Ç 60 —Ç—ã—Å—è—á
    –î–æ 60 —Ç—ã—Å—è—á –î–æ—Å—Ç–∞–≤–∫–∞ 2 500‚ÇΩ
    –ü–æ–¥—ä–µ–º 200‚ÇΩ —ç—Ç–∞–∂.`,
    { keyboard: String(menu) }
  );
});

/*----------------------------------------------------------------------------------------------------------*/
/*----------------------------------------------------------------------------------------------------------*/

const catalog = baseBuilder.clone();
const menu = baseBuilder.clone();

/*----------------------------------------------------------------------------------------------------------*/

menu
  .textButton({
    label: `üìï –ö–∞—Ç–∞–ª–æ–≥`,
    payload: { command: `–∫–∞—Ç–∞–ª–æ–≥` },
    color: Keyboard.POSITIVE_COLOR,
  })
  .row()
  .textButton({
    label: `‚úç –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –æ–Ω–ª–∞–π–Ω?`,
    payload: { command: `–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .row()
  .textButton({
    label: `‚òé –¢–µ–ª–µ—Ñ–æ–Ω`,
    payload: { command: `–¢–µ–ª–µ—Ñ–æ–Ω` },
    color: Keyboard.POSITIVE_COLOR,
  })
  .textButton({
    label: `üóì –ì—Ä–∞—Ñ–∏–∫`,
    payload: { command: `–ì—Ä–∞—Ñ–∏–∫` },
    color: Keyboard.POSITIVE_COLOR,
  })
  .row()
  .textButton({
    label: `üìç –ù–∞—à –∞–¥—Ä–µ—Å`,
    payload: { command: `–ù–∞—à –∞–¥—Ä–µ—Å` },
    color: Keyboard.POSITIVE_COLOR,
  })
  .textButton({
    label: `üöö –î–æ—Å—Ç–∞–≤–∫–∞`,
    payload: { command: `–î–æ—Å—Ç–∞–≤–∫–∞` },
    color: Keyboard.POSITIVE_COLOR,
  })
  .row();

/*----------------------------------------------------------------------------------------------------------*/

var catalog_link = catalogBD;

catalog
  .textButton({
    label: `üîπ 1`,
    payload: { command: `–∞–∫—Ü–∏–∏` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üîπ 2`,
    payload: { command: `–¥–∏–≤–∞–Ω—ã` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üîπ 3`,
    payload: { command: `–º–∞—Ç—Ä–∞—Å—ã –∏ —á–µ—Ö–ª—ã` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üîπ 4`,
    payload: { command: `—à–∫–∞—Ñ—ã-–∫—É–ø–µ` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .row()
  .textButton({
    label: `üî∏ 5`,
    payload: { command: `—à–∫–∞—Ñ—ã —Ä–∞—Å–ø–∞—à–Ω—ã–µ` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üî∏ 6`,
    payload: { command: `–≥–æ—Å—Ç–∏–Ω—ã–µ` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üî∏ 7`,
    payload: { command: `–∫—Ä–æ–≤–∞—Ç–∏` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üî∏ 8`,
    payload: { command: `—Å–ø–∞–ª—å–Ω—ã–µ –≥–∞—Ä–Ω–∏—Ç—É—Ä—ã` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .row()
  .textButton({
    label: `üîπ 9`,
    payload: { command: `–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Å—Ç–æ–ª—ã` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üîπ 10`,
    payload: { command: `–≤—Å—ë –¥–ª—è –¥–µ—Ç–µ–π` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üîπ 11`,
    payload: { command: `–¥–µ—Ç—Å–∫–∏–µ –º–∞—Ç—Ä–∞—Å—ã` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üîπ 12`,
    payload: { command: `–∫–æ–º–æ–¥—ã` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .row()
  .textButton({
    label: `üî∏ 13`,
    payload: { command: `—Ç–≤ —Ç—É–º–±—ã` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üî∏ 14`,
    payload: { command: `–ø—Ä–∏—Ö–æ–∂–∏–µ` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üî∏ 15`,
    payload: { command: `–∫—Ä–µ—Å–ª–∞` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .textButton({
    label: `üî∏ 16`,
    payload: { command: `–º–∞–ª—ã–µ —Ñ–æ—Ä–º—ã` },
    color: Keyboard.PRIMARY_COLOR,
  })
  .row()
  .textButton({
    label: `üìï –ö–∞—Ç–∞–ª–æ–≥`,
    payload: { command: `–∫–∞—Ç–∞–ª–æ–≥` },
    color: Keyboard.POSITIVE_COLOR,
  })
  .textButton({
    label: `üìï –í –Ω–∞–ª–∏—á–∏–∏`,
    payload: { command: `–í –Ω–∞–ª–∏—á–∏–∏` },
    color: Keyboard.POSITIVE_COLOR,
  })
  .row()
  .textButton({
    label: `‚ùå –ú–µ–Ω—é`,
    payload: { command: `–º–µ–Ω—é` },
    color: Keyboard.NEGATIVE_COLOR,
  });

/*----------------------------------------------------------------------------------------------------------*/

function date() {
  return `[${moment(Date.now()).format("DD.MM.YYYY | HH:mm:ss")}]`.red;
}

/*----------------------------------------------------------------------------------------------------------*/

async function bot(hearConditions, handler) {
  hearManager.hear(hearConditions, handler);
}

/*----------------------------------------------------------------------------------------------------------*/

function rand(min, max) {
  return Math.round(Math.random() * (max - min)) + min;
}

/*----------------------------------------------------------------------------------------------------------*/
async function run() {
  await vk.updates.startPolling();
}
run()
  .then(() => {
    console.log("[START] --> ");
  })
  .catch((error) => {
    console.error("[ERROR] | " + error);
  });

/*----------------------------------------------------------------------------------------------------------*/
/*========================================DEVELOPER VLAD KUCHER=============================================*/
/*===========================================vk.com/c_o_d_e_r===============================================*/
/*----------------------------------------------------------------------------------------------------------*/
